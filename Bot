import logging
from aiogram import Bot, Dispatcher, types
from aiogram.types import ChatPermissions
from aiogram.utils import executor
from datetime import timedelta

API_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù"

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
warnings = {}
moderators = set()
shadowbanned_users = set()

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
ADMIN_CHAT_ID =  -1002414519688  # ID –∞–¥–º–∏–Ω–∞
MESSAGE_THRESHOLD = 100  # –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–≤


# –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
@dp.message_handler(content_types=["new_chat_members"])
async def greet_new_user(message: types.Message):
    for user in message.new_chat_members:
        await message.reply(f"–ü—Ä–∏–≤–µ—Ç, {user.full_name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –≥—Ä—É–ø–ø—É. "
                            "–ü—Ä–∞–≤–∏–ª–∞ –≤ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. –û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ /help.")


# –ö–æ–º–∞–Ω–¥–∞ /help
@dp.message_handler(commands=["help"])
async def send_help(message: types.Message):
    help_text = """
    ‚öôÔ∏è **–ö–æ–º–∞–Ω–¥—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏:**
    /warn - –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    /mute <—Å–µ–∫—É–Ω–¥—ã> - –ó–∞–º—å—é—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    /ban <—Å–µ–∫—É–Ω–¥—ã> - –ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    /kick - –ò—Å–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥—Ä—É–ø–ø—ã
    /clear <–∫–æ–ª-–≤–æ> - –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    /shadowban - –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∏—Ö–∏–π –±–∞–Ω
    /report - –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    /alert <—Ç–µ–∫—Å—Ç> - –£–≤–µ–¥–æ–º–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
    /addmoder - –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º

    üõ† **–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º!**
    """
    await message.reply(help_text, parse_mode="Markdown")


# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
@dp.message_handler(commands=["addmoder"])
async def add_moderator(message: types.Message):
    if message.reply_to_message:
        user = message.reply_to_message.from_user
        moderators.add(user.id)
        await message.reply(f"‚úÖ {user.full_name} –Ω–∞–∑–Ω–∞—á–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.")


# –ú—å—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.message_handler(commands=["mute"])
async def mute_user(message: types.Message):
    if message.from_user.id in moderators:
        if message.reply_to_message:
            user = message.reply_to_message.from_user
            duration = int(message.text.split()[1])
            permissions = ChatPermissions(can_send_messages=False)
            await bot.restrict_chat_member(message.chat.id, user.id, permissions, 
                                           until_date=message.date + timedelta(seconds=duration))
            await message.reply(f"üîá {user.full_name} –∑–∞–º—å—é—á–µ–Ω –Ω–∞ {duration} —Å–µ–∫—É–Ω–¥.")


# –ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.message_handler(commands=["ban"])
async def ban_user(message: types.Message):
    if message.from_user.id in moderators:
        if message.reply_to_message:
            user = message.reply_to_message.from_user
            duration = int(message.text.split()[1])
            await bot.kick_chat_member(message.chat.id, user.id, 
                                       until_date=message.date + timedelta(seconds=duration))
            await message.reply(f"üö´ {user.full_name} –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ {duration} —Å–µ–∫—É–Ω–¥.")


# –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.message_handler(commands=["kick"])
async def kick_user(message: types.Message):
    if message.from_user.id in moderators:
        if message.reply_to_message:
            user = message.reply_to_message.from_user
            await message.chat.kick(user.id)
            await message.reply(f"üë¢ {user.full_name} –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –≥—Ä—É–ø–ø—ã.")


# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
@dp.message_handler(commands=["alert"])
async def alert_moderators(message: types.Message):
    if message.from_user.id in moderators:
        alert_text = message.text.split(maxsplit=1)[1]
        await bot.send_message(message.chat.id, f"üö® –í–Ω–∏–º–∞–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã: {alert_text}")


# –û—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
@dp.message_handler(commands=["clear"])
async def clear_messages(message: types.Message):
    if message.from_user.id in moderators:
        count = int(message.text.split()[1])
        async for msg in bot.iter_history(message.chat.id, limit=count):
            await msg.delete()
        await message.reply(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {count} —Å–æ–æ–±—â–µ–Ω–∏–π.")


# –¢–∏—Ö–∏–π –±–∞–Ω
@dp.message_handler(commands=["shadowban"])
async def shadowban_user(message: types.Message):
    if message.reply_to_message:
        user = message.reply_to_message.from_user
        shadowbanned_users.add(user.id)
        await message.reply(f"üîá {user.full_name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∏—Ö–∏–π –±–∞–Ω.")


@dp.message_handler()
async def shadowban_filter(message: types.Message):
    if message.from_user.id in shadowbanned_users:
        await message.delete()


# –û—Ç—á—ë—Ç—ã –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö
@dp.message_handler(commands=["report"])
async def report_user(message: types.Message):
    if message.reply_to_message:
        user = message.reply_to_message.from_user
        await bot.send_message(ADMIN_CHAT_ID, f"‚ö†Ô∏è –ñ–∞–ª–æ–±–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user.full_name}\n"
                                              f"–°–æ–æ–±—â–µ–Ω–∏–µ: {message.reply_to_message.text}")
        await message.reply("–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
